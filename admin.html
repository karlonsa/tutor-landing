<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель | Репетитор по математике и информатике</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .login-form { max-width: 400px; margin: 100px auto; }
        .editor-content { min-height: 200px; border: 1px solid #d1d5db; padding: 1rem; border-radius: 0.375rem; }
        body { background-color: #f3f4f6; }
        .admin-panel { display: none; }
        .table-container { overflow-x: auto; }
        .table-container table { min-width: 800px; }
        .status-new { background-color: #dbeafe; color: #1d4ed8; }
        .status-processed { background-color: #fef3c7; color: #d97706; }
        .status-completed { background-color: #dcfce7; color: #15803d; }
    </style>
</head>
<body class="font-sans min-h-screen">
    <!-- Форма входа -->
    <div id="loginContainer">
        <div class="login-form bg-white p-8 rounded-xl shadow-lg">
            <div class="text-center mb-8">
                <i class="fas fa-user-shield text-4xl text-blue-600 mb-4"></i>
                <h1 class="text-2xl font-bold">Вход в админ-панель</h1>
                <p class="text-gray-600 mt-2">Введите ваши учетные данные</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-2">Логин</label>
                    <input type="text" id="username" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required value="admin">
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">Пароль</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required value="admin123">
                </div>
                
                <div id="loginError" class="text-red-500 text-sm hidden">
                    Неверный логин или пароль
                </div>
                
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                    Войти
                </button>
            </form>
        </div>
    </div>

    <!-- Админ-панель -->
    <div id="adminPanel" class="admin-panel">
        <div class="bg-gray-800 text-white p-4">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center">
                    <i class="fas fa-user-shield text-xl mr-2"></i>
                    <span class="text-xl font-bold">Админ-панель ЕГЭМастер</span>
                </div>
                <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-md">
                    Выйти
                </button>
            </div>
        </div>

        <div class="container mx-auto p-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- Сайдбар -->
                <div class="md:col-span-1 bg-white rounded-lg shadow-md p-4">
                    <nav>
                        <ul class="space-y-2">
                            <li>
                                <button class="admin-tab w-full text-left px-4 py-2 rounded-md bg-blue-100 text-blue-700 font-medium" data-tab="reviews">
                                    <i class="fas fa-comments mr-2"></i> Управление отзывами
                                </button>
                            </li>
                            <li>
                                <button class="admin-tab w-full text-left px-4 py-2 rounded-md hover:bg-gray-100" data-tab="leads">
                                    <i class="fas fa-envelope mr-2"></i> Заявки от клиентов
                                </button>
                            </li>
                            <li>
                                <button class="admin-tab w-full text-left px-4 py-2 rounded-md hover:bg-gray-100" data-tab="settings">
                                    <i class="fas fa-cog mr-2"></i> Настройки
                                </button>
                            </li>
                        </ul>
                    </nav>
                </div>

                <!-- Основной контент -->
                <div class="md:col-span-3 space-y-6">
                    <!-- Управление отзывами -->
                    <div class="admin-tab-content bg-white rounded-lg shadow-md p-6" id="reviewsTab">
                        <h2 class="text-2xl font-bold mb-6">Управление отзывами</h2>
                        
                        <!-- Форма добавления отзыва -->
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold mb-4">Добавить новый отзыв</h3>
                            <form id="addReviewForm" class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 mb-2">Имя ученика</label>
                                    <input type="text" id="studentName" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">Дата отзыва</label>
                                    <input type="date" id="reviewDate" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">Текст отзыва</label>
                                    <textarea id="reviewText" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">Фото отзыва (скриншот)</label>
                                    <div class="border-2 border-dashed border-gray-300 rounded-md p-4 text-center">
                                        <input type="file" id="reviewImage" class="hidden" accept="image/*">
                                        <label for="reviewImage" class="cursor-pointer">
                                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                                            <p class="text-gray-500">Кликните для выбора файла</p>
                                        </label>
                                    </div>
                                    <div id="imagePreview" class="mt-2 hidden">
                                        <img id="previewImg" class="max-w-xs rounded border">
                                    </div>
                                </div>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md transition duration-300">
                                    Добавить отзыв
                                </button>
                            </form>
                        </div>

                        <!-- Существующие отзывы -->
                        <div>
                            <h3 class="text-xl font-semibold mb-4">Отзывы на сайте</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="reviewsGrid">
                                <p class="text-gray-500 text-center py-8 col-span-2">Загрузка отзывов...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Управление заявками -->
                    <div class="admin-tab-content bg-white rounded-lg shadow-md p-6 hidden" id="leadsTab">
                        <h2 class="text-2xl font-bold mb-6">Заявки от клиентов</h2>
                        
                        <div class="mb-6 flex justify-between items-center">
                            <div>
                                <span class="text-gray-600">Показано: <span id="leadsCount">0</span> заявок</span>
                            </div>
                            <div>
                                <button id="exportLeadsBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                                    <i class="fas fa-file-export mr-2"></i> Экспорт в CSV
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="min-w-full bg-white">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="py-3 px-4 text-left">Дата</th>
                                        <th class="py-3 px-4 text-left">Имя</th>
                                        <th class="py-3 px-4 text-left">Телефон</th>
                                        <th class="py-3 px-4 text-left">Email</th>
                                        <th class="py-3 px-4 text-left">Предмет</th>
                                        <th class="py-3 px-4 text-left">Статус</th>
                                        <th class="py-3 px-4 text-left">Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="leadsTable">
                                    <tr>
                                        <td colspan="7" class="text-center py-8 text-gray-500">Загрузка заявок...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Настройки -->
                    <div class="admin-tab-content bg-white rounded-lg shadow-md p-6 hidden" id="settingsTab">
                        <h2 class="text-2xl font-bold mb-6">Настройки системы</h2>
                        
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-xl font-semibold mb-4">Учетные данные администратора</h3>
                                <form id="adminSettingsForm" class="space-y-4">
                                    <div>
                                        <label class="block text-gray-700 mb-2">Новый логин</label>
                                        <input type="text" id="newUsername" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2">Новый пароль</label>
                                        <input type="password" id="newPassword" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2">Подтвердите пароль</label>
                                        <input type="password" id="confirmPassword" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                                        Сохранить изменения
                                    </button>
                                </form>
                            </div>
                            
                            <div>
                                <h3 class="text-xl font-semibold mb-4">Резервное копирование</h3>
                                <div class="flex space-x-4">
                                    <button id="backupBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                                        <i class="fas fa-download mr-2"></i> Создать резервную копию
                                    </button>
                                    <button id="restoreBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                                        <i class="fas fa-upload mr-2"></i> Восстановить из копии
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===================== БАЗА ДАННЫХ ===================== //
        class Database {
            constructor() {
                this.init();
            }
            
            // Инициализация базы данных
            init() {
                if (!localStorage.getItem('admin')) {
                    localStorage.setItem('admin', JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    }));
                }
                
                if (!localStorage.getItem('reviews')) {
                    localStorage.setItem('reviews', JSON.stringify([]));
                }
                
                if (!localStorage.getItem('leads')) {
                    localStorage.setItem('leads', JSON.stringify([]));
                }
            }
            
            // Администраторы
            getAdmin() {
                return JSON.parse(localStorage.getItem('admin'));
            }
            
            updateAdmin(credentials) {
                localStorage.setItem('admin', JSON.stringify(credentials));
            }
            
            // Отзывы
            getReviews() {
                return JSON.parse(localStorage.getItem('reviews'));
            }
            
            saveReviews(reviews) {
                localStorage.setItem('reviews', JSON.stringify(reviews));
            }
            
            addReview(review) {
                const reviews = this.getReviews();
                review.id = Date.now(); // Уникальный ID
                reviews.push(review);
                this.saveReviews(reviews);
                return review;
            }
            
            updateReview(id, updatedReview) {
                const reviews = this.getReviews();
                const index = reviews.findIndex(r => r.id === id);
                if (index !== -1) {
                    reviews[index] = {...reviews[index], ...updatedReview};
                    this.saveReviews(reviews);
                    return true;
                }
                return false;
            }
            
            deleteReview(id) {
                const reviews = this.getReviews();
                const filtered = reviews.filter(r => r.id !== id);
                this.saveReviews(filtered);
                return filtered.length !== reviews.length;
            }
            
            // Заявки
            getLeads() {
                try {
                    const data = localStorage.getItem('leads');
                    
                    // Если данных нет - возвращаем пустой массив
                    if (!data) return [];
                    
                    // Пробуем распарсить
                    return JSON.parse(data);
                } catch (e) {
                    console.error('Ошибка чтения заявок:', e);
                    return [];
                }
            }
            
            saveLeads(leads) {
                localStorage.setItem('leads', JSON.stringify(leads));
            }
            
            addLead(lead) {
                const leads = this.getLeads();
                lead.id = Date.now(); // Уникальный ID
                lead.date = new Date().toISOString();
                lead.status = 'new';
                leads.push(lead);
                this.saveLeads(leads);
                return lead;
            }
            
            updateLeadStatus(id, status) {
                const leads = this.getLeads();
                const index = leads.findIndex(l => l.id === id);
                if (index !== -1) {
                    leads[index].status = status;
                    this.saveLeads(leads);
                    return true;
                }
                return false;
            }
            
            deleteLead(id) {
                const leads = this.getLeads();
                const filtered = leads.filter(l => l.id !== id);
                this.saveLeads(filtered);
                return filtered.length !== leads.length;
            }
            
            // Резервное копирование
            backup() {
                return {
                    admin: this.getAdmin(),
                    reviews: this.getReviews(),
                    leads: this.getLeads(),
                    timestamp: new Date().toISOString()
                };
            }
            
            restore(backupData) {
                if (backupData.admin) {
                    localStorage.setItem('admin', JSON.stringify(backupData.admin));
                }
                if (backupData.reviews) {
                    localStorage.setItem('reviews', JSON.stringify(backupData.reviews));
                }
                if (backupData.leads) {
                    localStorage.setItem('leads', JSON.stringify(backupData.leads));
                }
            }
        }

        // Создаем экземпляр базы данных
        const db = new Database();

        // ===================== АДМИН-ПАНЕЛЬ ===================== //
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация приложения
            initApp();
        });
        
        function initApp() {
            // Проверка авторизации
            checkAuth();
            
            // Настройка обработчиков событий
            setupEventListeners();
        }
        
        function checkAuth() {
            const isAuthenticated = sessionStorage.getItem('isAuthenticated') === 'true';
            const loginContainer = document.getElementById('loginContainer');
            const adminPanel = document.getElementById('adminPanel');
            
            if (isAuthenticated) {
                loginContainer.style.display = 'none';
                adminPanel.style.display = 'block';
                loadAdminContent();
            } else {
                loginContainer.style.display = 'block';
                adminPanel.style.display = 'none';
            }
        }
        
        function setupEventListeners() {
            // Форма входа
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Кнопка выхода
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Форма добавления отзыва
            document.getElementById('addReviewForm').addEventListener('submit', handleAddReview);
            
            // Превью изображения
            document.getElementById('reviewImage').addEventListener('change', handleImagePreview);
            
            // Экспорт заявок
            document.getElementById('exportLeadsBtn').addEventListener('click', exportLeadsToCSV);
            
            // Настройки администратора
            document.getElementById('adminSettingsForm').addEventListener('submit', handleAdminSettings);
            
            // Резервное копирование
            document.getElementById('backupBtn').addEventListener('click', createBackup);
            document.getElementById('restoreBtn').addEventListener('click', restoreBackup);
        }
        
        // ===================== АВТОРИЗАЦИЯ ===================== //
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('loginError');
            
            const admin = db.getAdmin();
            
            if (username === admin.username && password === admin.password) {
                sessionStorage.setItem('isAuthenticated', 'true');
                checkAuth();
            } else {
                errorElement.textContent = 'Неверный логин или пароль';
                errorElement.classList.remove('hidden');
                setTimeout(() => errorElement.classList.add('hidden'), 3000);
            }
        }
        
        function logout() {
            sessionStorage.removeItem('isAuthenticated');
            checkAuth();
        }
        
        // ===================== ОТЗЫВЫ ===================== //
        function loadReviews() {
            const reviews = db.getReviews();
            const reviewsGrid = document.getElementById('reviewsGrid');
            reviewsGrid.innerHTML = '';
            
            if (reviews.length === 0) {
                reviewsGrid.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-2">Нет отзывов</p>';
                return;
            }
            
            reviews.forEach(review => {
                const reviewCard = document.createElement('div');
                reviewCard.className = 'border rounded-lg overflow-hidden bg-white';
                reviewCard.innerHTML = `
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold">${review.name}</h4>
                                <p class="text-gray-500 text-sm">${review.date}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button class="edit-review text-blue-600 hover:text-blue-800" data-id="${review.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-review text-red-600 hover:text-red-800" data-id="${review.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-gray-700 mb-3">${review.text}</p>
                        ${review.image ? `<img src="${review.image}" alt="Отзыв ${review.name}" class="w-full h-24 object-cover rounded">` : ''}
                    </div>
                `;
                reviewsGrid.appendChild(reviewCard);
            });
            
            // Обработчики для кнопок
            document.querySelectorAll('.edit-review').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    editReview(id);
                });
            });
            
            document.querySelectorAll('.delete-review').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteReview(id);
                });
            });
        }
        
        function handleAddReview(e) {
            e.preventDefault();
            
            const name = document.getElementById('studentName').value;
            const date = document.getElementById('reviewDate').value;
            const text = document.getElementById('reviewText').value;
            const fileInput = document.getElementById('reviewImage');
            
            // Форматирование даты
            const formattedDate = new Date(date).toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            
            const newReview = {
                name: name,
                date: formattedDate,
                text: text,
                image: null
            };
            
            // Обработка изображения
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    newReview.image = e.target.result;
                    db.addReview(newReview);
                    loadReviews();
                    resetReviewForm();
                    alert('Отзыв успешно добавлен!');
                };
                
                reader.readAsDataURL(file);
            } else {
                db.addReview(newReview);
                loadReviews();
                resetReviewForm();
                alert('Отзыв успешно добавлен!');
            }
        }
        
        function editReview(id) {
            const reviews = db.getReviews();
            const review = reviews.find(r => r.id === id);
            
            if (!review) return;
            
            // Заполнение формы данными
            document.getElementById('studentName').value = review.name;
            
            // Преобразуем дату в формат YYYY-MM-DD
            const [day, month, year] = review.date.split('.');
            const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            document.getElementById('reviewDate').value = formattedDate;
            
            document.getElementById('reviewText').value = review.text;
            
            // Удаление старого отзыва
            db.deleteReview(id);
            loadReviews();
            
            alert('Отзыв загружен для редактирования. Внесите изменения и нажмите "Добавить отзыв"');
        }
        
        function deleteReview(id) {
            if (confirm('Вы уверены, что хотите удалить этот отзыв?')) {
                db.deleteReview(id);
                loadReviews();
                alert('Отзыв успешно удален!');
            }
        }
        
        function resetReviewForm() {
            document.getElementById('addReviewForm').reset();
            document.getElementById('imagePreview').classList.add('hidden');
        }
        
        function handleImagePreview() {
            const fileInput = document.getElementById('reviewImage');
            const preview = document.getElementById('previewImg');
            const previewContainer = document.getElementById('imagePreview');
            
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    previewContainer.classList.remove('hidden');
                };
                
                reader.readAsDataURL(fileInput.files[0]);
            }
        }
        
        // ===================== ЗАЯВКИ ===================== //
        function loadLeads() {
            const leads = db.getLeads();
            const leadsTable = document.getElementById('leadsTable');
            const leadsCount = document.getElementById('leadsCount');
            
            leadsTable.innerHTML = '';
            leadsCount.textContent = leads.length;
            
            if (leads.length === 0) {
                leadsTable.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-gray-500">Нет заявок</td>
                    </tr>
                `;
                return;
            }
            
            leads.forEach(lead => {
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td class="py-3 px-4">${new Date(lead.date).toLocaleDateString()}</td>
                    <td class="py-3 px-4">${lead.name}</td>
                    <td class="py-3 px-4">${lead.phone}</td>
                    <td class="py-3 px-4">${lead.email || '-'}</td>
                    <td class="py-3 px-4">${lead.subject}</td>
                    <td class="py-3 px-4">
                        <span class="status-badge px-2 py-1 rounded text-xs font-medium ${getStatusClass(lead.status)}">
                            ${getStatusText(lead.status)}
                        </span>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-2">
                            <button class="change-status text-blue-600 hover:text-blue-800" data-id="${lead.id}">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="delete-lead text-red-600 hover:text-red-800" data-id="${lead.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                leadsTable.appendChild(row);
            });
            
            // Обработчики для кнопок
            document.querySelectorAll('.change-status').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    changeLeadStatus(id);
                });
            });
            
            document.querySelectorAll('.delete-lead').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteLead(id);
                });
            });
        }
        
        function getStatusClass(status) {
            switch(status) {
                case 'new': return 'status-new';
                case 'processed': return 'status-processed';
                case 'completed': return 'status-completed';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'new': return 'Новая';
                case 'processed': return 'В работе';
                case 'completed': return 'Завершена';
                default: return status;
            }
        }
        
        function changeLeadStatus(id) {
            const lead = db.getLeads().find(l => l.id === id);
            if (!lead) return;
            
            const statuses = ['new', 'processed', 'completed'];
            const currentIndex = statuses.indexOf(lead.status);
            const nextIndex = (currentIndex + 1) % statuses.length;
            
            db.updateLeadStatus(id, statuses[nextIndex]);
            loadLeads();
            alert('Статус заявки обновлен!');
        }
        
        function deleteLead(id) {
            if (confirm('Вы уверены, что хотите удалить эту заявку?')) {
                db.deleteLead(id);
                loadLeads();
                alert('Заявка успешно удалена!');
            }
        }
        
        function exportLeadsToCSV() {
            const leads = db.getLeads();
            if (leads.length === 0) {
                alert('Нет данных для экспорта');
                return;
            }
            
            // Заголовки CSV
            let csvContent = 'Дата;Имя;Телефон;Email;Предмет;Статус\n';
            
            // Данные
            leads.forEach(lead => {
                const date = new Date(lead.date).toLocaleDateString();
                const name = lead.name;
                const phone = lead.phone;
                const email = lead.email || '';
                const subject = lead.subject;
                const status = getStatusText(lead.status);
                
                csvContent += `${date};${name};${phone};${email};${subject};${status}\n`;
            });
            
            // Создаем Blob и ссылку для скачивания
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `leads_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ===================== НАСТРОЙКИ ===================== //
        function handleAdminSettings(e) {
            e.preventDefault();
            
            const newUsername = document.getElementById('newUsername').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword && newPassword !== confirmPassword) {
                alert('Пароли не совпадают!');
                return;
            }
            
            const admin = db.getAdmin();
            
            if (newUsername) {
                admin.username = newUsername;
            }
            
            if (newPassword) {
                admin.password = newPassword;
            }
            
            db.updateAdmin(admin);
            alert('Настройки администратора обновлены!');
            this.reset();
        }
        
        function createBackup() {
            const backup = db.backup();
            const json = JSON.stringify(backup, null, 2);
            
            // Создаем Blob и ссылку для скачивания
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `backup_${backup.timestamp.replace(/:/g, '-')}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function restoreBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    try {
                        const backupData = JSON.parse(event.target.result);
                        db.restore(backupData);
                        alert('База данных успешно восстановлена из резервной копии!');
                        loadAdminContent();
                    } catch (error) {
                        alert('Ошибка при восстановлении: неверный формат файла');
                        console.error(error);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // ===================== ВКЛАДКИ ===================== //
        function initAdminTabs() {
            const adminTabs = document.querySelectorAll('.admin-tab');
            adminTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Удаляем активный класс у всех вкладок
                    adminTabs.forEach(t => t.classList.remove('bg-blue-100', 'text-blue-700'));
                    // Добавляем активный класс текущей вкладке
                    this.classList.add('bg-blue-100', 'text-blue-700');
                    
                    // Скрываем все содержимое вкладок
                    document.querySelectorAll('.admin-tab-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Показываем содержимое текущей вкладки
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}Tab`).classList.remove('hidden');

                    // Обновляем данные при переключении вкладки
                    if (tabId === 'reviews') {
                        loadReviews();
                    } else if (tabId === 'leads') {
                        loadLeads(); // Добавлена перезагрузка заявок
                    }
                });
            });
        }
        
        // ===================== ЗАГРУЗКА ДАННЫХ ===================== //
        function loadAdminContent() {
            loadReviews();
            loadLeads();
            initAdminTabs();
        }
    </script>
</body>
</html>